name: Daily mortgage rates

on:
  schedule:
    # 07:30 America/New_York == 12:30 UTC (standard time)
    - cron: "30 12 * * *"
  workflow_dispatch:

jobs:
  fetch-and-store:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Run collector + verification (real data)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          EMAIL_PROVIDER_KEY: ${{ secrets.EMAIL_PROVIDER_KEY }}
          DEFAULT_STATE: MA
          DEFAULT_LOAN_AMOUNT: "600000"
          DEFAULT_LTV: "80"
          DEFAULT_FICO: "760"
          DEFAULT_LOCK_DAYS: "30"
        run: |
          set -euxo pipefail
          # Map GitHub secret name -> expected env var
          export SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE"
          bash scripts/run_verify.sh

      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "Mortgage Rates Update - ${{ job.status }}"
          to: jhasavi@gmail.com
          from: Mortgage Rate Tracker <noreply@namastebostonhomes.com>
          body: |
            Daily mortgage rates collection completed.
            
            Status: ${{ job.status }}
            Run: ${{ github.run_number }}
            Time: ${{ github.event.repository.updated_at }}
            
            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Latest rates: https://www.namastebostonhomes.com/rates

      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-logs
          path: |
            **/*.log
          if-no-files-found: ignore
